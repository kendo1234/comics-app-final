{% extends "base.html" %} {% block content %}
<div class="search-form">
  <form
    method="GET"
    action="{{ url_for('search') }}"
    style="display: flex; gap: 1rem; width: 100%"
  >
    <div class="form-group" style="flex: 1; margin-bottom: 0">
      <label for="search">Search Comics:</label>
      <input
        type="search"
        id="search"
        name="q"
        placeholder="Search by title, writer, or artist..."
        value="{{ search_query or '' }}"
      />
    </div>
    <div style="align-self: end">
      <button type="submit" class="btn">Search</button>
      {% if search_query %}
      <a href="{{ url_for('index') }}" class="btn btn-neutral"
        >Clear</a
      >
      {% endif %}
    </div>
  </form>
</div>

<!-- Sorting Controls -->
<div
  class="sorting-controls"
  style="
    margin: 1rem 0;
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  "
>
  <span style="font-weight: bold">Sort by:</span>

  {% set current_sort = sort_by or 'title' %} {% set current_order = sort_order
  or 'asc' %}

  <!-- Title Sort -->
  <a
    href="{{ url_for('index' if not search_query else 'search', 
                      q=search_query if search_query else none,
                      sort='title', 
                      order='desc' if current_sort == 'title' and current_order == 'asc' else 'asc',
                      page=1) }}"
    class="btn {{ 'btn-active' if current_sort == 'title' else '' }}"
  >
    Title {% if current_sort == 'title' %} {{ '↓' if current_order == 'desc'
    else '↑' }} {% endif %}
  </a>

  <!-- Writer Sort -->
  <a
    href="{{ url_for('index' if not search_query else 'search', 
                      q=search_query if search_query else none,
                      sort='writer', 
                      order='desc' if current_sort == 'writer' and current_order == 'asc' else 'asc',
                      page=1) }}"
    class="btn {{ 'btn-active' if current_sort == 'writer' else '' }}"
  >
    Writer {% if current_sort == 'writer' %} {{ '↓' if current_order == 'desc'
    else '↑' }} {% endif %}
  </a>

  <!-- Artist Sort -->
  <a
    href="{{ url_for('index' if not search_query else 'search', 
                      q=search_query if search_query else none,
                      sort='artist', 
                      order='desc' if current_sort == 'artist' and current_order == 'asc' else 'asc',
                      page=1) }}"
    class="btn {{ 'btn-active' if current_sort == 'artist' else '' }}"
  >
    Artist {% if current_sort == 'artist' %} {{ '↓' if current_order == 'desc'
    else '↑' }} {% endif %}
  </a>

  <!-- Volume Sort -->
  <a
    href="{{ url_for('index' if not search_query else 'search', 
                      q=search_query if search_query else none,
                      sort='volume', 
                      order='desc' if current_sort == 'volume' and current_order == 'asc' else 'asc',
                      page=1) }}"
    class="btn {{ 'btn-active' if current_sort == 'volume' else '' }}"
  >
    Volume {% if current_sort == 'volume' %} {{ '↓' if current_order == 'desc'
    else '↑' }} {% endif %}
  </a>

  <!-- Clear Sort -->
  <a
    href="{{ url_for('index' if not search_query else 'search', 
                      q=search_query if search_query else none,
                      page=1) }}"
    class="btn btn-neutral"
    style="margin-left: 0.5rem"
  >
    Clear Sort
  </a>
</div>

{% if search_query %}
<h2>Search Results for "{{ search_query }}" ({{ total_comics }} found)</h2>
{% else %}
<h2>All Comics ({{ total_comics }} total)</h2>
{% endif %}

<!-- Pagination Info -->
{% if total_pages > 1 %}
<div class="text-muted" style="margin: 1rem 0; text-align: center">
  Showing {{ ((page - 1) * per_page + 1) }} - {{ (page * per_page if page *
  per_page < total_comics else total_comics) }} of {{ total_comics }} comics
  (Page {{ page }} of {{ total_pages }})
</div>
{% endif %} {% if comics %}
<table>
  <thead>
    <tr>
      <th>Title</th>
      <th>Volume</th>
      <th>Writer</th>
      <th>Artist</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for comic in comics %}
    <tr>
      <td><strong>{{ comic.title }}</strong></td>
      <td>{{ comic.volume }}</td>
      <td>{{ comic.writer }}</td>
      <td>{{ comic.artist }}</td>
      <td>
        <div class="actions">
          <a href="{{ url_for('edit_comic', comic_id=comic.id) }}" class="btn"
            >Edit</a
          >
          <a
            href="{{ url_for('delete_comic', comic_id=comic.id) }}"
            class="btn btn-danger"
            onclick="
              return confirm('Are you sure you want to delete this comic?');
            "
            >Delete</a
          >
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="card">
  {% if search_query %}
  <p>
    No comics found matching "{{ search_query }}".
    <a href="{{ url_for('index') }}">View all comics</a>
  </p>
  {% else %}
  <p>
    No comics in your collection yet.
    <a href="{{ url_for('add_comic') }}">Add your first comic!</a>
  </p>
  {% endif %}
</div>
{% endif %}

<!-- Pagination Controls -->
{% if total_pages > 1 %}
<div class="pagination" style="margin: 2rem 0; text-align: center">
  <!-- Previous Page -->
  {% if has_prev %}
  <a
    href="{{ url_for('index' if not search_query else 'search',
                        q=search_query if search_query else none,
                        sort=sort_by if sort_by else none,
                        order=sort_order if sort_order else none,
                        page=prev_page) }}"
    class="btn"
  >
    ← Previous
  </a>
  {% else %}
  <span class="btn btn-disabled">
    ← Previous
  </span>
  {% endif %}

  <!-- Page Numbers -->
  {% set start_page = [1, page - 2]|max %} {% set end_page = [total_pages, page
  + 2]|min %} {% if start_page > 1 %}
  <a
    href="{{ url_for('index' if not search_query else 'search',
                        q=search_query if search_query else none,
                        sort=sort_by if sort_by else none,
                        order=sort_order if sort_order else none,
                        page=1) }}"
    class="btn"
    style="margin: 0 0.25rem"
    >1</a
  >
  {% if start_page > 2 %}
  <span style="margin: 0 0.5rem">...</span>
  {% endif %} {% endif %} {% for page_num in range(start_page, end_page + 1) %}
  {% if page_num == page %}
  <span class="btn btn-active" style="margin: 0 0.25rem"
    >{{ page_num }}</span
  >
  {% else %}
  <a
    href="{{ url_for('index' if not search_query else 'search',
                          q=search_query if search_query else none,
                          sort=sort_by if sort_by else none,
                          order=sort_order if sort_order else none,
                          page=page_num) }}"
    class="btn"
    style="margin: 0 0.25rem"
    >{{ page_num }}</a
  >
  {% endif %} {% endfor %} {% if end_page < total_pages %} {% if end_page <
  total_pages - 1 %}
  <span style="margin: 0 0.5rem">...</span>
  {% endif %}
  <a
    href="{{ url_for('index' if not search_query else 'search',
                        q=search_query if search_query else none,
                        sort=sort_by if sort_by else none,
                        order=sort_order if sort_order else none,
                        page=total_pages) }}"
    class="btn"
    style="margin: 0 0.25rem"
    >{{ total_pages }}</a
  >
  {% endif %}

  <!-- Next Page -->
  {% if has_next %}
  <a
    href="{{ url_for('index' if not search_query else 'search',
                        q=search_query if search_query else none,
                        sort=sort_by if sort_by else none,
                        order=sort_order if sort_order else none,
                        page=next_page) }}"
    class="btn"
  >
    Next →
  </a>
  {% else %}
  <span class="btn btn-disabled">
    Next →
  </span>
  {% endif %}
</div>
{% endif %}

<div style="margin-top: 2rem; text-align: center">
  <a href="{{ url_for('add_comic') }}" class="btn btn-success">Add New Comic</a>
  <a
    href="{{ url_for('add_multiple_comics') }}"
    class="btn btn-success"
    >Add Multiple Comics</a
  >
</div>
{% endblock %}
